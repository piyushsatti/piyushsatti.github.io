---
type TechStack = "frontend" | "backend" | "data" | "infra" | "general";
type LanguageId =
  | "python"
  | "java"
  | "javascript"
  | "typescript"
  | "sql"
  | "cpp"
  | "bash"
  | "matlab"
  | "css";

interface TechItem {
  name: string;
  stack: TechStack;
  languages?: LanguageId[];
  tags?: string[];
}

export interface Props {
  title?: string;
  subtitle?: string;
  idPrefix?: string;
}

const {
  title = "Technical Skills",
  subtitle = "Filter by language, stack, and focus area.",
  idPrefix = "tech",
} = Astro.props as Props;

const stackLabels: Record<TechStack, string> = {
  frontend: "Frontend",
  backend: "Backend",
  data: "Data/ML",
  infra: "Infra",
  general: "General",
};

const languageLabels: Record<LanguageId, string> = {
  python: "Python",
  java: "Java",
  javascript: "JavaScript",
  typescript: "TypeScript",
  sql: "SQL",
  cpp: "C/C++",
  bash: "Bash",
  matlab: "MATLAB",
  css: "CSS",
};

const languageOptions: LanguageId[] = [
  "python",
  "java",
  "javascript",
  "typescript",
  "sql",
  "cpp",
  "bash",
  "matlab",
  "css",
];

const items: TechItem[] = [
  { name: "Python", stack: "backend", languages: ["python"] },
  { name: "Java", stack: "backend", languages: ["java"] },
  { name: "TypeScript", stack: "frontend", languages: ["typescript"] },
  { name: "JavaScript", stack: "frontend", languages: ["javascript"] },
  { name: "SQL", stack: "data", languages: ["sql"] },
  { name: "C/C++", stack: "general", languages: ["cpp"] },
  { name: "Bash", stack: "infra", languages: ["bash"] },
  { name: "MATLAB", stack: "data", languages: ["matlab"] },
  { name: "Astro", stack: "frontend", languages: ["javascript", "typescript"] },
  { name: "Next.js", stack: "frontend", languages: ["javascript", "typescript"] },
  { name: "Tailwind CSS", stack: "frontend", languages: ["css"] },
  { name: "FastAPI", stack: "backend", languages: ["python"] },
  { name: "Flask", stack: "backend", languages: ["python"] },
  { name: "Spring Boot", stack: "backend", languages: ["java"] },
  { name: "Express.js", stack: "backend", languages: ["javascript"] },
  { name: "Node.js", stack: "backend", languages: ["javascript"] },
  { name: "PostgreSQL", stack: "data", languages: ["sql"] },
  { name: "MongoDB", stack: "data" },
  { name: "Redis", stack: "data" },
  { name: "Apache Spark", stack: "data", languages: ["python"] },
  { name: "NumPy", stack: "data", languages: ["python"] },
  { name: "Pandas", stack: "data", languages: ["python"] },
  { name: "PyTorch", stack: "data", languages: ["python"] },
  { name: "Scikit-learn", stack: "data", languages: ["python"] },
  { name: "Docker", stack: "infra" },
  { name: "GitHub Actions", stack: "infra" },
  { name: "Git/GitHub", stack: "general" },
  { name: "DigitalOcean", stack: "infra" },
  { name: "Vercel", stack: "frontend" },
  { name: "Supabase", stack: "data" },
  { name: "Nginx", stack: "infra" },
  { name: "Kafka", stack: "backend" },
  { name: "Elasticsearch", stack: "data" },
  { name: "Serverless", stack: "infra" },
  { name: "Microservices", stack: "backend" },
  { name: "Monolithic", stack: "backend" },
];

const searchId = `${idPrefix}-tech-search`;
const titleId = `${idPrefix}-tech-title`;
---

<section class="tech-section" data-tech-section>
  <header class="tech-section__header">
    <div class="tech-section__intro">
      <h2 id={titleId}>{title}</h2>
      <p class="tech-section__subtitle">{subtitle}</p>
    </div>
    <div class="tech-section__count" aria-live="polite">
      <span data-tech-count>0</span> shown
    </div>
  </header>

  <div class="tech-filters">
    <div
      class="tech-filters__group tech-filters__group--language"
      data-filter-group="language"
      role="group"
      aria-label="Filter by language"
    >
      <span class="tech-filters__label">Language</span>
      <button type="button" class="chip is-active" data-filter="all" aria-pressed="true">
        All
      </button>
      {languageOptions.map((lang) => (
        <button type="button" class="chip" data-filter={lang} aria-pressed="false">
          {languageLabels[lang]}
        </button>
      ))}
    </div>

    <div
      class="tech-filters__group"
      data-filter-group="stack"
      role="group"
      aria-label="Filter by stack"
    >
      <span class="tech-filters__label">Stack</span>
      <button type="button" class="chip is-active" data-filter="all" aria-pressed="true">
        All
      </button>
      <button type="button" class="chip" data-filter="frontend" aria-pressed="false">
        Frontend
      </button>
      <button type="button" class="chip" data-filter="backend" aria-pressed="false">
        Backend
      </button>
      <button type="button" class="chip" data-filter="data" aria-pressed="false">
        Data/ML
      </button>
      <button type="button" class="chip" data-filter="infra" aria-pressed="false">
        Infra
      </button>
      <button type="button" class="chip" data-filter="general" aria-pressed="false">
        General
      </button>
    </div>

    <div class="tech-filters__group tech-filters__group--search">
      <label class="tech-filters__label" for={searchId}>Search</label>
      <input
        id={searchId}
        class="tech-search"
        type="search"
        placeholder="Search tech..."
        data-tech-search
      />
    </div>
  </div>

  <div class="tech-grid" data-tech-grid aria-labelledby={titleId}>
    {items.map((item) => {
      const stackLabel = stackLabels[item.stack];
      const languageTokens = (item.languages ?? []).map(
        (lang) => languageLabels[lang] ?? lang
      );
      const searchTokens = [
        item.name,
        stackLabel,
        ...languageTokens,
        ...(item.languages ?? []),
        ...(item.tags ?? []),
      ]
        .join(" ")
        .toLowerCase();
      return (
        <article
          class="tech-card"
          data-tech-item
          data-stack={item.stack}
          data-languages={(item.languages ?? []).join(" ")}
          data-search={searchTokens}
        >
          <div class="tech-card__header">
            <h3>{item.name}</h3>
          </div>
          <div class="tech-card__meta">
            <span class="tech-badge">{stackLabel}</span>
          </div>
        </article>
      );
    })}
  </div>

  <p class="tech-empty" data-tech-empty hidden>No matches. Try adjusting filters.</p>
</section>

<script is:inline>
  (() => {
    const section = document.currentScript?.previousElementSibling;
    if (!(section instanceof HTMLElement)) return;

    const cards = Array.from(section.querySelectorAll("[data-tech-item]"));
    const countEl = section.querySelector("[data-tech-count]");
    const emptyEl = section.querySelector("[data-tech-empty]");
    const searchInput = section.querySelector("[data-tech-search]");
    const groups = Array.from(section.querySelectorAll("[data-filter-group]"));

    const state = {
      stack: "all",
      language: "all",
      query: "",
    };

    const applyFilters = () => {
      let visible = 0;
      const query = state.query.trim().toLowerCase();

      cards.forEach((card) => {
        const stack = card.getAttribute("data-stack") || "";
        const languages = (card.getAttribute("data-languages") || "")
          .split(" ")
          .filter(Boolean);
        const haystack = (card.getAttribute("data-search") || "").toLowerCase();

        let match = true;
        if (state.stack !== "all" && state.stack !== stack) match = false;
        if (state.language !== "all" && !languages.includes(state.language)) {
          match = false;
        }
        if (query && !haystack.includes(query)) match = false;

        card.hidden = !match;
        if (match) visible += 1;
      });

      if (countEl) countEl.textContent = String(visible);
      if (emptyEl) emptyEl.hidden = visible !== 0;
    };

    groups.forEach((group) => {
      const groupKey = group.getAttribute("data-filter-group");
      if (!groupKey) return;
      const buttons = Array.from(group.querySelectorAll("button[data-filter]"));

      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          const value = button.getAttribute("data-filter") || "all";
          state[groupKey] = value;

          buttons.forEach((btn) => {
            const isActive = btn === button;
            btn.classList.toggle("is-active", isActive);
            btn.setAttribute("aria-pressed", String(isActive));
          });

          applyFilters();
        });
      });
    });

    if (searchInput instanceof HTMLInputElement) {
      searchInput.addEventListener("input", () => {
        state.query = searchInput.value;
        applyFilters();
      });
    }

    applyFilters();
  })();
</script>
