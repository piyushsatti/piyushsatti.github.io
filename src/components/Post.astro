---
import FormattedDate from "./FormattedDate.astro";

export interface MetaItem {
  label: string;
  value: string;
}

export interface LinkItem {
  label: string;
  href: string;
  external?: boolean;
}

export interface Props {
  title: string;
  description?: string;
  variant: "blog" | "projects" | "research";
  summary?: string;
  heroImage?: string;
  heroImageAlt?: string;
  heroImageCaption?: string;
  pubDate?: Date | string;
  updatedDate?: Date | string;
  tags?: string[];
  meta?: MetaItem[];
  tldr?: string[];
  links?: LinkItem[];
  Content?: any;
}

const {
  title,
  description,
  variant,
  summary,
  heroImage,
  heroImageAlt,
  heroImageCaption,
  pubDate,
  updatedDate,
  tags = [],
  meta = [],
  tldr = [],
  links = [],
  Content,
} = Astro.props as Props;

const toDate = (value?: Date | string) => {
  if (!value) return undefined;
  return value instanceof Date ? value : new Date(value);
};

const publishedAt = toDate(pubDate);
const updatedAt = toDate(updatedDate);
const hasMeta = meta.length > 0 || publishedAt || updatedAt;
const base = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + "/";
---

<article class={`post-full post-full--${variant}`}>
  <header class="post-full__header">
    <p class="post-full__variant">{variant}</p>
    <h1>{title}</h1>
    {description && <p class="post-full__description">{description}</p>}

    {
      (hasMeta || links.length > 0) && (
        <div class="post-full__meta">
          <div class="post-full__meta-group">
            {publishedAt && (
              <span>
                Published <FormattedDate date={publishedAt} />
              </span>
            )}
            {updatedAt && (
              <span>
                Updated <FormattedDate date={updatedAt} />
              </span>
            )}
            {meta.map((item) => (
              <span>
                <strong>{item.label}:</strong> {item.value}
              </span>
            ))}
          </div>
          {links.length > 0 && (
            <div class="post-full__links">
              {links.map((link, index) => (
                <>
                  <a
                    href={
                      link.href.startsWith("/")
                        ? `${base}${link.href.replace(/^\//, "")}`
                        : link.href
                    }
                    target={
                      (link.external ?? link.href.startsWith("http"))
                        ? "_blank"
                        : undefined
                    }
                    rel={
                      (link.external ?? link.href.startsWith("http"))
                        ? "noopener"
                        : undefined
                    }
                  >
                    {link.label}
                  </a>
                  {index < links.length - 1 && (
                    <span class="post-full__divider">::</span>
                  )}
                </>
              ))}
            </div>
          )}
        </div>
      )
    }

    {
      tags.length > 0 && (
        <div class="post-full__tags">
          {tags.map((tag, index) => (
            <span class="post-full__tag">
              <a href={`${base}tags/${tag}/`}>{tag}</a>
              {index < tags.length - 1 && (
                <span class="post-full__tags-divider" aria-hidden="true">
                  â€¢
                </span>
              )}
            </span>
          ))}
        </div>
      )
    }
  </header>

  {
    heroImage && (
      <figure class="post-full__cover">
        <img src={heroImage} alt={heroImageAlt ?? title} />
        {heroImageCaption && (
          <figcaption class="post-full__caption">{heroImageCaption}</figcaption>
        )}
      </figure>
    )
  }

  {summary && <p class="post-full__summary">{summary}</p>}

  {
    tldr.length > 0 && (
      <section class="post-full__tldr">
        <h2>TL;DR</h2>
        <ul>
          {tldr.map((item) => (
            <li>{item}</li>
          ))}
        </ul>
      </section>
    )
  }

  <section class="post-full__content">
    {Content ? <Content /> : <slot />}
  </section>
</article>
